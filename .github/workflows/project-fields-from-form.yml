name: Sync issue form to Project fields (USER test)

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created, edited]
  workflow_dispatch:
    inputs:
      issue_number:
        description: "Manual sync target issue number"
        required: true
        type: number

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write   # ì½”ë©˜íŠ¸/ë³¸ë¬¸ ì—…ë°ì´íŠ¸
      pull-requests: read

    env:
      USER: "hwijae33"
      PROJECT_NUMBER: "4"

      PRIORITY_FIELD_NAME: "Priority"
      COMPONENT_FIELD_NAME: "Component"
      CHANGE_TYPE_FIELD_NAME: "Change Type"
      DUEDATE_FIELD_NAME: "Due Date"
      SUMMARY_FIELD_NAME: "Summary"   # (ì„ íƒ) Text í•„ë“œ
      DDAY_FIELD_NAME: "D-Day"        # (ì„ íƒ) Text í•„ë“œ

    steps:
      - uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECTS_TOKEN }}
          script: |
            const gql = github.graphql;
            const ops = [];

            // === helpers ===
            const byName = (fields, n) => fields.find(f => f && f.name === n);
            const KST_TODAY = () => new Date().toLocaleString('sv-SE', { timeZone: 'Asia/Seoul' }).slice(0,10);
            const isISO = (s) => /^\d{4}-\d{2}-\d{2}$/.test(s) && !Number.isNaN(new Date(`${s}T00:00:00Z`).getTime());

            // relative date parser (/due ...)
            function parseHumanDate(input){
              if (!input) return null;
              const s = input.trim().toLowerCase();
              const tz = 'Asia/Seoul';
              // ISO
              if (isISO(s)) return s;
              // clear
              if (s === 'clear') return 'CLEAR';
              // today / tomorrow
              if (s === 'today') return KST_TODAY();
              if (s === 'tomorrow') {
                const t = new Date(new Date().toLocaleString('en-US', { timeZone: tz }));
                t.setDate(t.getDate()+1);
                return t.toLocaleString('sv-SE', { timeZone: tz }).slice(0,10);
              }
              // +Nd / +Nw / +Nm
              let m = s.match(/^\+(\d+)(d|w|m)$/);
              if (m) {
                const n = parseInt(m[1],10); const unit = m[2];
                const t = new Date(new Date().toLocaleString('en-US', { timeZone: tz }));
                if (unit==='d') t.setDate(t.getDate()+n);
                if (unit==='w') t.setDate(t.getDate()+7*n);
                if (unit==='m') t.setMonth(t.getMonth()+n);
                return t.toLocaleString('sv-SE', { timeZone: tz }).slice(0,10);
              }
              // next monday
              m = s.match(/^next\s+(mon|monday|tue|tuesday|wed|wednesday|thu|thursday|fri|friday|sat|saturday|sun|sunday)$/);
              if (m) {
                const map = {sun:0, sunday:0, mon:1, monday:1, tue:2, tuesday:2, wed:3, wednesday:3, thu:4, thursday:4, fri:5, friday:5, sat:6, saturday:6};
                const target = map[m[1]];
                const now = new Date(new Date().toLocaleString('en-US', { timeZone: tz }));
                let d = now.getDay();
                let add = (7 - d + target) % 7;
                if (add === 0) add = 7;
                now.setDate(now.getDate()+add);
                return now.toLocaleString('sv-SE', { timeZone: tz }).slice(0,10);
              }
              return null;
            }

            function diffDaysKST(iso){
              if (!iso) return null;
              const tz = "Asia/Seoul";
              const todayStr = new Date().toLocaleString("sv-SE", { timeZone: tz }).slice(0,10);
              const [ty,tm,td] = todayStr.split("-").map(Number);
              const [y,m,d]    = iso.split("-").map(Number);
              const t0 = Date.UTC(ty, tm-1, td);
              const d0 = Date.UTC(y, m-1, d);
              return Math.round((d0 - t0) / 86400000);
            }
            function ddayLabel(n){ if (n===0) return "D-Day"; return n>0 ? `D-${n}` : `D+${Math.abs(n)}`; }

            // === 0) í”„ë¡œì íŠ¸ ë©”íƒ€ ===
            const userLogin = (process.env.USER || "").trim();
            const projectNumber = Number(process.env.PROJECT_NUMBER || "0");
            if (!userLogin || !projectNumber) { core.setFailed("USER/PROJECT_NUMBER missing"); return; }

            const resUser = await gql(`
              query($login:String!, $num:Int!) {
                user(login:$login){
                  projectV2(number:$num){
                    id title
                    fields(first:100){
                      nodes{
                        ... on ProjectV2FieldCommon       { id name }
                        ... on ProjectV2SingleSelectField { id name options { id name } }
                      }
                    }
                  }
                }
              }
            `, { login: userLogin, num: projectNumber });

            const project = resUser?.user?.projectV2;
            if (!project) { core.setFailed("Project not found. Check USER/PROJECT_NUMBER."); return; }
            const fields = project.fields.nodes;

            const fPriority   = byName(fields, process.env.PRIORITY_FIELD_NAME);
            const fComponent  = byName(fields, process.env.COMPONENT_FIELD_NAME);
            const fChangeType = byName(fields, process.env.CHANGE_TYPE_FIELD_NAME);
            const fDue        = byName(fields, process.env.DUEDATE_FIELD_NAME);
            const fSummary    = byName(fields, process.env.SUMMARY_FIELD_NAME);
            const fDDay       = byName(fields, process.env.DDAY_FIELD_NAME);

            // === 1) ëŒ€ìƒ ì´ìŠˆ íŒë³„ ===
            const owner = context.repo.owner;
            const repo  = context.repo.repo;
            let issue;
            if (context.eventName === "workflow_dispatch") {
              const num = Number(core.getInput("issue_number"));
              if (!num) { core.setFailed("workflow_dispatch requires issue_number"); return; }
              const { data } = await github.rest.issues.get({ owner, repo, issue_number: num });
              issue = data;
            } else if (context.eventName === "issue_comment") {
              issue = context.payload.issue;
            } else {
              issue = context.payload.issue;
            }

            // === 2) í”„ë¡œì íŠ¸ ì•„ì´í…œ ë³´ì¥ ===
            const resIssue = await gql(`
              query($id:ID!){
                node(id:$id){
                  ... on Issue {
                    id number
                    projectItems(first:30){ nodes { id project { id } } }
                  }
                }
              }`, { id: issue.node_id });

            const issueNode = resIssue.node;
            let itemId = issueNode.projectItems.nodes.find(n => n.project.id === project.id)?.id;
            if (!itemId) {
              const add = await gql(`
                mutation($pid:ID!,$content:ID!){
                  addProjectV2ItemById(input:{projectId:$pid, contentId:$content}) {
                    item { id }
                  }
                }`, { pid: project.id, content: issueNode.id });
              itemId = add.addProjectV2ItemById.item.id;
              ops.push(`â• Added to project "${project.title}" (Issue #${issueNode.number})`);
            }

            // === 3) /due ëª…ë ¹ ì²˜ë¦¬ (issue_comment) ===
            let forcedDue = null;  // 'CLEAR' | 'YYYY-MM-DD' | null
            if (context.eventName === "issue_comment") {
              const body = context.payload.comment?.body || "";
              const m = body.match(/^\s*\/due\s+(.+)$/im);
              if (m) {
                const arg = m[1].trim();
                const parsed = parseHumanDate(arg);
                if (parsed === 'CLEAR') {
                  forcedDue = 'CLEAR';
                  ops.push(`ğŸ—‘ Clear Due Date by /due clear`);
                } else if (parsed && isISO(parsed)) {
                  forcedDue = parsed;
                  ops.push(`âœï¸ Set Due Date by /due â†’ ${parsed}`);
                } else {
                  core.setFailed(`Invalid /due argument: "${arg}" (use YYYY-MM-DD, +Nd/+Nw/+Nm, today, tomorrow, next monday, or clear)`);
                  return;
                }
              }
            }

            // === 4) ì´ìŠˆ í¼ ë³¸ë¬¸ íŒŒì‹± (issues.opened/edited/workflow_dispatch) ===
            const issueBody = issue.body || "";
            const pick = (label) => {
              const re = new RegExp(`^###\\s*${label}\\s*\\n+([\\s\\S]*?)(?=\\n###|$)`, "m");
              const m = issueBody.match(re);
              return m ? m[1].trim() : "";
            };
            const stripMd = (s) => (s || "").replace(/(^_+|_+$)/g,"").replace(/[*`~>|]/g,"").trim();
            const emptyLike = (s) => !s || /^no response$/i.test(s) || /^n\/a$/i.test(s) || /^none$/i.test(s) || /^-+$/.test(s);

            let vPriority   = stripMd(pick("Priority"));
            let vComponent  = stripMd(pick("Component"));
            let vChangeType = stripMd(pick("Change Type"));
            let vDue        = stripMd(pick("Due Date"));
            if (emptyLike(vDue)) vDue = "";

            // === 5) í˜„ì¬ Due Date ì½ê¸° (UI ì¡´ì¤‘) ===
            let currentDue = "";
            if (fDue) {
              const resVals = await gql(`
                query($item: ID!) {
                  node(id: $item) {
                    ... on ProjectV2Item {
                      fieldValues(first: 50) {
                        nodes {
                          ... on ProjectV2ItemFieldDateValue {
                            date
                            field { ... on ProjectV2FieldCommon { id name } }
                          }
                        }
                      }
                    }
                  }
                }`, { item: itemId });
              currentDue = resVals?.node?.fieldValues?.nodes?.find(n => n?.field?.id === fDue?.id)?.date || "";
            }

            // === 6) Due Date ê²°ì • ìˆœì„œ ===
            //  (a) /due ê°•ì œê°’ì´ ìˆìœ¼ë©´ ê·¸ê±¸ ì‚¬ìš©
            //  (b) ì—†ìœ¼ë©´ í¼ê°’(ISO)ì´ë©´ ì‚¬ìš©
            //  (c) í¼/í”„ë¡œì íŠ¸ ëª¨ë‘ ë¹„ì—ˆë‹¤ë©´ ì˜¤ëŠ˜(KST)
            let finalDue = currentDue || ""; // ê¸°ë³¸ì€ í˜„ì¬ê°’ ìœ ì§€
            let dueChanged = false;

            if (forcedDue === 'CLEAR') {
              // clear field
              if (fDue) {
                await gql(`
                  mutation($pid:ID!,$item:ID!,$fid:ID!){
                    clearProjectV2ItemFieldValue(input:{ projectId:$pid, itemId:$item, fieldId:$fid }) {
                      projectV2Item { id }
                    }
                  }`, { pid: project.id, item: itemId, fid: fDue.id });
                ops.push("ğŸ” Due Date cleared");
                finalDue = "";
                dueChanged = true;
              }
            } else if (typeof forcedDue === 'string' && isISO(forcedDue)) {
              if (forcedDue !== currentDue) {
                await gql(`
                  mutation($pid:ID!,$item:ID!,$fid:ID!,$date:Date!){
                    updateProjectV2ItemFieldValue(input:{
                      projectId:$pid, itemId:$item, fieldId:$fid, value:{ date:$date }
                    }){ projectV2Item { id } }
                  }`, { pid: project.id, item: itemId, fid: fDue.id, date: forcedDue });
                ops.push(`ğŸ” Due Date â†’ ${forcedDue}`);
                finalDue = forcedDue;
                dueChanged = true;
              }
            } else {
              // ê¸°ì¡´ ë¡œì§
              let isoDue = "";
              if (isISO(vDue)) {
                isoDue = vDue;
              } else if (!vDue && !currentDue) {
                isoDue = KST_TODAY();
                ops.push(`â„¹ï¸ Due Date empty â†’ defaulting to ${isoDue} (KST today)`);
              }
              if (isoDue && isoDue !== currentDue) {
                await gql(`
                  mutation($pid:ID!,$item:ID!,$fid:ID!,$date:Date!){
                    updateProjectV2ItemFieldValue(input:{
                      projectId:$pid, itemId:$item, fieldId:$fid, value:{ date:$date }
                    }){ projectV2Item { id } }
                  }`, { pid: project.id, item: itemId, fid: fDue.id, date: isoDue });
                ops.push(`ğŸ” Due Date â†’ ${isoDue}`);
                finalDue = isoDue;
                dueChanged = true;
              } else {
                finalDue = currentDue; // ìœ ì§€
              }
            }

            // === 7) ë‚˜ë¨¸ì§€ í•„ë“œ ë™ê¸°í™” (í¼ ê¸°ë°˜: issue_comment ì‹œì—ë„ ìœ ì§€ ê°€ëŠ¥) ===
            const updateSelect = async (field, valueText, label) => {
              if (!field?.options?.length || !valueText) return;
              const opt = field.options.find(o => o.name === valueText);
              if (!opt) { ops.push(`âš ï¸ ${label}: option "${valueText}" not found`); return; }
              await gql(`
                mutation($pid:ID!,$item:ID!,$fid:ID!,$opt:String!){
                  updateProjectV2ItemFieldValue(input:{
                    projectId:$pid, itemId:$item, fieldId:$fid, value:{ singleSelectOptionId:$opt }
                  }){ projectV2Item { id } }
                }`, { pid: project.id, item: itemId, fid: field.id, opt: opt.id });
              ops.push(`ğŸ” ${label} â†’ ${valueText}`);
            };
            const updateText = async (field, text, label) => {
              if (!field || !text) return;
              await gql(`
                mutation($pid:ID!,$item:ID!,$fid:ID!,$txt:String!){
                  updateProjectV2ItemFieldValue(input:{
                    projectId:$pid, itemId:$item, fieldId:$fid, value:{ text:$txt }
                  }){ projectV2Item { id } }
                }`, { pid: project.id, item: itemId, fid: field.id, txt: text });
              ops.push(`ğŸ” ${label} â†’ ${text}`);
            };

            // í¼ ê¸°ë°˜ ì‹±ê¸€ ì…€ë ‰íŠ¸ ë™ê¸°í™” (issue_comment ê²½ë¡œì—ì„œë„ í¼ì´ ìˆë‹¤ë©´ ìœ ì§€)
            await updateSelect(fPriority,   vPriority,   "Priority");
            await updateSelect(fComponent,  vComponent,  "Component");
            await updateSelect(fChangeType, vChangeType, "Change Type");

            // === 8) Summary / D-Day í…ìŠ¤íŠ¸ í•„ë“œ ê°±ì‹  ===
            const prMap = { Critical:"ğŸ”¥ Critical", High:"ğŸš¨ High", Medium:"âš–ï¸ Medium", Low:"ğŸ’¤ Low" };
            const ctMap = { feat:"ğŸŒŸ feat", fix:"ğŸ›  fix", refactor:"â™»ï¸ refactor", docs:"ğŸ“ docs", perf:"âš¡ perf",
                            chore:"ğŸ§¹ chore", test:"âœ… test", ci:"ğŸ¤– ci", build:"ğŸ“¦ build", revert:"â†©ï¸ revert" };
            const parts = [];
            if (vChangeType) parts.push(ctMap[vChangeType] || `ğŸ· ${vChangeType}`);
            if (vComponent)  parts.push(`ğŸ§© ${vComponent}`);
            if (vPriority)   parts.push(prMap[vPriority] || vPriority);
            if (finalDue)    parts.push(`â° ${finalDue} (${ddayLabel(diffDaysKST(finalDue))})`);

            const summaryText = parts.join(" Â· ");
            if (fSummary && summaryText) await updateText(fSummary, summaryText, process.env.SUMMARY_FIELD_NAME);
            if (fDDay) {
              const d = finalDue ? ddayLabel(diffDaysKST(finalDue)) : "";
              if (d) await updateText(fDDay, d, process.env.DDAY_FIELD_NAME);
            }

            // === 9) Summary ì½”ë©˜íŠ¸ ì—…ì„œíŠ¸ ===
            const marker = "<!-- project-sync-summary -->";
            const prettyDate = finalDue
              ? new Intl.DateTimeFormat("en-US", { month:"short", day:"numeric", year:"numeric", timeZone:"Asia/Seoul" })
                  .format(new Date(finalDue+"T00:00:00+09:00"))
              : "";

            const mdLines = [
              marker,
              "### ğŸ§¾ Summary",
              `- **Priority:** ${vPriority || "_(none)_"}`,
              `- **Component:** ${vComponent || "_(none)_"}`,
              `- **Change Type:** ${vChangeType || "_(none)_"}`,
              `- **Due Date:** ${finalDue ? `${prettyDate} (${ddayLabel(diffDaysKST(finalDue))})` : "_(none)_"}`,
              "",
              "> ë‚ ì§œ ë°”ê¾¸ê¸°: `/due 2025-11-06`, `/due +3d`, `/due next monday`, `/due today|tomorrow`, `/due clear`",
              "> í•„ë“œëŠ” í”„ë¡œì íŠ¸ ì¹´ë“œì—ë„ ë™ê¸°í™”ë©ë‹ˆë‹¤. í¼/í”„ë¡œì íŠ¸ê°€ ë¹„ì–´ ìˆìœ¼ë©´ Due DateëŠ” KST ì˜¤ëŠ˜ë¡œ ê¸°ë³¸ ì„¤ì •ë©ë‹ˆë‹¤.",
              marker
            ];
            const md = mdLines.join("\n");

            const list = await github.rest.issues.listComments({ owner, repo, issue_number: issue.number, per_page: 100 });
            const existing = (list.data || []).find(c => (c.body || "").includes(marker));
            if (existing) {
              await github.rest.issues.updateComment({ owner, repo, comment_id: existing.id, body: md });
              ops.push("ğŸ“ Updated summary comment");
            } else {
              await github.rest.issues.createComment({ owner, repo, issue_number: issue.number, body: md });
              ops.push("ğŸ“ Created summary comment");
            }

            // === 10) ë³¸ë¬¸ tidy (opened ì‹œ 1íšŒ) ===
            if (context.eventName === "issues" && context.payload.action === "opened") {
              const tidyMarker = "<!-- project-sync-tidied -->";
              const { data: fresh } = await github.rest.issues.get({ owner, repo, issue_number: issue.number });
              let ibody = fresh.body || "";
              if (!ibody.includes(tidyMarker)) {
                const stripSection = (src, label) =>
                  src.replace(
                    new RegExp(`(^|\\n)###\\s*${label}\\s*\\r?\\n+[\\s\\S]*?(?=(\\n###\\s)|$)`, "m"),
                    (m, p1) => (p1 ? p1 : "")
                  ).trim();
                const SECTIONS = ["Priority", "Component", "Change Type", "Due Date"];
                let newBody = ibody;
                for (const sec of SECTIONS) newBody = stripSection(newBody, sec);
                const notice = [
                  tidyMarker,
                  "> â„¹ï¸ ì´ ì´ìŠˆëŠ” **Projects í•„ë“œì™€ ë™ê¸°í™”**ë©ë‹ˆë‹¤. ìƒë‹¨ í¼ ì„¹ì…˜ì€ ìˆ¨ê¸°ê³  ì•„ë˜ **Summary**ì—ì„œ í•µì‹¬ë§Œ ë³´ì—¬ì¤ë‹ˆë‹¤.",
                  "> ìƒì„¸ ì„œìˆ ì€ **Details** ì„¹ì…˜ì„ ì‚¬ìš©í•˜ì„¸ìš”.",
                  ""
                ].join("\n");
                newBody = `${notice}${newBody}`;
                await github.rest.issues.update({ owner, repo, issue_number: issue.number, body: newBody });
                ops.push("ğŸ§¹ Tidied issue body (hid form sections)");
              }
            }

            // === 11) ë¡œê·¸ ===
            console.log(ops.length ? ops.join('\n') : 'No field changes.');
