name: Sync issue form to Project fields (USER test)

on:
  issues:
    types: [opened, edited]

jobs:
  sync:
    runs-on: ubuntu-latest
    env:
      # === ê°œì¸ í”„ë¡œì íŠ¸ìš© ì„¤ì • (USERë§Œ! ORGëŠ” ë¹„ì›Œë‘ì„¸ìš”) ===
      USER: "hwijae33"              # â† ì§€ê¸ˆ í…ŒìŠ¤íŠ¸ìš© ì‚¬ìš©ì ë¡œê·¸ì¸
      PROJECT_NUMBER: "4"           # â† ë³¸ì¸ ê°œì¸ Projects ë²ˆí˜¸ë¡œ êµì²´

      # === í”„ë¡œì íŠ¸ ì¸¡ í•„ë“œ ì´ë¦„(Projectsì— ë§Œë“  í•„ë“œëª…ê³¼ ë°˜ë“œì‹œ ì² ì ë™ì¼) ===
      PRIORITY_FIELD_NAME: "Priority"
      COMPONENT_FIELD_NAME: "Component"
      AREA_FIELD_NAME: "Area"
      STORYPOINTS_FIELD_NAME: "Story Points"
      DUEDATE_FIELD_NAME: "Due Date"
      TABLES_FIELD_NAME: "Tables"   # (ìˆìœ¼ë©´) ì²´í¬ë°•ìŠ¤ í•©ì¹œ í…ìŠ¤íŠ¸ ì €ì¥

      # (ì˜µì…˜) Review Status ê¸°ë³¸ê°’
      REVIEW_FIELD_NAME: "Review Status"
      REVIEW_DEFAULT: "Pending"

    steps:
      - uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.PROJECTS_TOKEN }}
          script: |
            const gql = github.graphql;
            const ops = [];

            // === 0) í”„ë¡œì íŠ¸ ë©”íƒ€ ì¡°íšŒ (USER ì „ìš©) ===
            const userLogin = (process.env.USER || "").trim();
            const projectNumber = Number(process.env.PROJECT_NUMBER || "0");
            if (!userLogin)   { core.setFailed("USER is empty"); return; }
            if (!projectNumber){ core.setFailed("PROJECT_NUMBER is empty/invalid"); return; }

            const { user } = await gql(`
              query($login:String!, $num:Int!) {
                user(login:$login){
                  projectV2(number:$num){
                    id
                    title
                    fields(first:100){
                      nodes{
                        ... on ProjectV2FieldCommon       { id name }
                        ... on ProjectV2SingleSelectField { id name options { id name } }
                      }
                    }
                  }
                }
              }
            `, { login: userLogin, num: projectNumber });

            const project = user?.projectV2;
            if (!project) { core.setFailed("Project not found. Check USER/PROJECT_NUMBER."); return; }
            const fields = project.fields.nodes;
            const byName = (n) => fields.find(f => f && f.name === n);

            const fPriority  = byName(process.env.PRIORITY_FIELD_NAME);
            const fComponent = byName(process.env.COMPONENT_FIELD_NAME);
            const fArea      = byName(process.env.AREA_FIELD_NAME);
            const fSP        = byName(process.env.STORYPOINTS_FIELD_NAME);
            const fDue       = byName(process.env.DUEDATE_FIELD_NAME);
            const fTables    = byName(process.env.TABLES_FIELD_NAME);
            const fReview    = byName(process.env.REVIEW_FIELD_NAME);

            // === 1) ì´ìŠˆ í¼ ë³¸ë¬¸ íŒŒì‹± ===
            const issue = context.payload.issue;
            const body  = issue.body || "";

            const pick = (label) => {
              const re = new RegExp(`^###\\s*${label}\\s*\\n+([\\s\\S]*?)(?=\\n###|$)`, "m");
              const m = body.match(re);
              return m ? m[1].trim() : "";
            };

            // ë“œë¡­ë‹¤ìš´/ì²´í¬ë°•ìŠ¤ì— ëŒ€ì‘ (work-item.yml ë¼ë²¨ê³¼ ì •í™•íˆ ì¼ì¹˜)
            const vPriority  = pick("Priority");            // Single-select
            const vComponent = pick("Component");           // Single-select
            const vArea      = pick("Area");                // Single-select
            const vSPraw     = pick("Story Points");        // "1".."13" (ë¬¸ìì—´)
            const vDueY      = pick("Due Year");            // "2025"
            const vDueM      = pick("Due Month");           // "01".."12"
            const vDueD      = pick("Due Day");             // "01".."31"
            const vReview    = pick("Review Status");       // Single-select (ìˆìœ¼ë©´)
            const vTablesRaw = pick("Affected Tables");     // ì²´í¬ë°•ìŠ¤ ì„¹ì…˜ ì›ë¬¸

            // ì²´í¬ë°•ìŠ¤ ì„¹ì…˜ì—ì„œ ì²´í¬ëœ í•­ëª©ë§Œ ì¶”ì¶œ: "- [x] name"
            const tables = vTablesRaw
              .split(/\r?\n/)
              .filter(line => /\-\s*\[x\]\s+/i.test(line))
              .map(line => line.replace(/^\-\s*\[x\]\s*/i, "").trim());
            const tablesText = tables.join(", ");

            // ë‚ ì§œ ì¡°í•© (ìœ íš¨ì„± ê°„ë‹¨ ê²€ì¦)
            let iso = "";
            if (vDueY && vDueM && vDueD) {
              const MM = vDueM.padStart ? vDueM.padStart(2,"0") : vDueM;
              const DD = vDueD.padStart ? vDueD.padStart(2,"0") : vDueD;
              const test = new Date(`${vDueY}-${MM}-${DD}T00:00:00Z`);
              if (!Number.isNaN(test.getTime())) iso = `${vDueY}-${MM}-${DD}`;
              else ops.push(`âš ï¸ Due Date invalid: ${vDueY}-${vDueM}-${vDueD}`);
            }
            const vSP = Number(vSPraw);

            // === 2) ì´ìŠˆ â†’ í”„ë¡œì íŠ¸ ì•„ì´í…œ ë³´ì¥ ===
            const resIssue = await gql(`
              query($id:ID!){
                node(id:$id){
                  ... on Issue {
                    id number
                    projectItems(first:30){ nodes { id project { id } } }
                  }
                }
              }`, { id: issue.node_id });
            const issueNode = resIssue.node;

            let itemId = issueNode.projectItems.nodes.find(n => n.project.id === project.id)?.id;
            if (!itemId) {
              const add = await gql(`
                mutation($pid:ID!,$content:ID!){
                  addProjectV2ItemById(input:{projectId:$pid, contentId:$content}) {
                    item { id }
                  }
                }`, { pid: project.id, content: issueNode.id });
              itemId = add.addProjectV2ItemById.item.id;
              ops.push(`â• Added to project "${project.title}" (Issue #${issueNode.number})`);
            } else {
              ops.push(`âœ“ Already in project "${project.title}" (Issue #${issueNode.number})`);
            }

            // === 3) ê³µí†µ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ë“¤ ===
            const updateSelect = async (field, valueText, label) => {
              if (!field?.options?.length || !valueText) return;
              const opt = field.options.find(o => o.name === valueText);
              if (!opt) { ops.push(`âš ï¸ ${label}: option "${valueText}" not found`); return; }
              await gql(`
                mutation($pid:ID!,$item:ID!,$fid:ID!,$opt:String!){
                  updateProjectV2ItemFieldValue(input:{
                    projectId:$pid, itemId:$item, fieldId:$fid,
                    value:{ singleSelectOptionId:$opt }
                  }){ projectV2Item { id } }
                }`, { pid: project.id, item: itemId, fid: field.id, opt: opt.id });
              ops.push(`ğŸ” ${label} â†’ ${valueText}`);
            };

            const updateNumber = async (field, num, label) => {
              if (!field || Number.isNaN(num)) return;
              await gql(`
                mutation($pid:ID!,$item:ID!,$fid:ID!,$val:Float!){
                  updateProjectV2ItemFieldValue(input:{
                    projectId:$pid, itemId:$item, fieldId:$fid,
                    value:{ number:$val }
                  }){ projectV2Item { id } }
                }`, { pid: project.id, item: itemId, fid: field.id, val: num });
              ops.push(`ğŸ” ${label} â†’ ${num}`);
            };

            const updateDate = async (field, iso, label) => {
              if (!field || !iso) return;
              if (!/^\d{4}-\d{2}-\d{2}$/.test(iso)) { ops.push(`âš ï¸ ${label}: invalid "${iso}"`); return; }
              await gql(`
                mutation($pid:ID!,$item:ID!,$fid:ID!,$date:Date!){
                  updateProjectV2ItemFieldValue(input:{
                    projectId:$pid, itemId:$item, fieldId:$fid,
                    value:{ date:$date }
                  }){ projectV2Item { id } }
                }`, { pid: project.id, item: itemId, fid: field.id, date: iso });
              ops.push(`ğŸ” ${label} â†’ ${iso}`);
            };

            const updateText = async (field, text, label) => {
              if (!field || !text) return;
              await gql(`
                mutation($pid:ID!,$item:ID!,$fid:ID!,$txt:String!){
                  updateProjectV2ItemFieldValue(input:{
                    projectId:$pid, itemId:$item, fieldId:$fid,
                    value:{ text:$txt }
                  }){ projectV2Item { id } }
                }`, { pid: project.id, item: itemId, fid: field.id, txt: text });
              ops.push(`ğŸ” ${label} â†’ ${text}`);
            };

            // === 4) ì‹¤ì œ í•„ë“œ ì“°ê¸° ===
            await updateSelect(fPriority,  vPriority,  "Priority");
            await updateSelect(fComponent, vComponent, "Component");
            await updateSelect(fArea,      vArea,      "Area");
            await updateNumber(fSP,        vSP,        "Story Points");
            if (iso) await updateDate(fDue, iso,       "Due Date");
            if (tablesText) await updateText(fTables,  tablesText, "Tables");
            if (fReview?.options?.length) {
              // í¼ê°’ ìš°ì„ , ì—†ìœ¼ë©´ ê¸°ë³¸ê°’
              const target = vReview || process.env.REVIEW_DEFAULT || "";
              if (target) await updateSelect(fReview, target, "Review Status");
            }

            // === 5) ì•¡ì…˜ ìš”ì•½ ì½˜ì†”ì— ì¶œë ¥ ===
            const summary = ops.length ? ops.join('\n') : 'No field changes.';
            console.log(summary);
