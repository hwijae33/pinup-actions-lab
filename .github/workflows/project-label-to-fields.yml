name: Sync labels to Project fields

on:
  issues:
    types: [opened, edited, labeled, unlabeled, milestoned, demilestoned]

jobs:
  sync-project-fields:
    runs-on: ubuntu-latest
    env:
      USER: "hwijae33"        # ★ 개인 프로젝트: USER만 채움
      PROJECT_NUMBER: "4"     # ★ 프로젝트 번호 (URL의 마지막 숫자)
      PRIORITY_PREFIX: "priority/"
      COMPONENT_PREFIX: "component/"
      STORYPOINTS_PREFIX: "sp/"
      PRIORITY_MAP: "critical:Critical,high:High,medium:Medium,low:Low"
      PRIORITY_FIELD_NAME: "Priority"
      COMPONENT_FIELD_NAME: "Component"
      STORYPOINTS_FIELD_NAME: "Story Points"
      DUEDATE_FIELD_NAME: "Due Date"

    steps:
      - uses: actions/github-script@v6
        with:
          # PAT 시크릿 주입 (Projects: RW / Issues/PR: Read 권한)
          github-token: ${{ secrets.PROJECTS_TOKEN }}
          script: |
            const gql = github.graphql;

            const userLogin = (process.env.USER || "").trim();
            const projectNumber = Number(process.env.PROJECT_NUMBER);
            if (!userLogin) { core.setFailed("USER is empty"); return; }

            // 1) 사용자 프로젝트/필드 조회  ← ★ $login:String! (non-null), $org 제거
            const { user } = await gql(`
              query($login:String!, $num:Int!) {
                user(login:$login){
                  projectV2(number:$num){
                    id
                    fields(first:100){
                      nodes{
                        ... on ProjectV2FieldCommon { id name }
                        ... on ProjectV2SingleSelectField { id name options { id name } }
                      }
                    }
                  }
                }
              }
            `, { login: userLogin, num: projectNumber });

            if (!user?.projectV2) { core.setFailed("Project not found. Check USER/PROJECT_NUMBER."); return; }
            const project = user.projectV2;
            const fields = project.fields.nodes;

            // 2) 이슈 노드 조회
            const issueNodeRes = await gql(`
              query($id:ID!){
                node(id:$id){
                  ... on Issue {
                    id
                    labels(first:50){ nodes { name } }
                    milestone { dueOn }
                    projectItems(first:30){ nodes { id project { id } } }
                  }
                }
              }
            `, { id: context.payload.issue.node_id });
            const issueNode = issueNodeRes.node;

            // 3) 프로젝트 아이템 없으면 추가
            let itemId = issueNode.projectItems.nodes.find(n => n.project.id === project.id)?.id;
            if (!itemId) {
              const addRes = await gql(`
                mutation($pid:ID!,$content:ID!){
                  addProjectV2ItemById(input:{projectId:$pid, contentId:$content}) {
                    item { id }
                  }
                }
              `, { pid: project.id, content: issueNode.id });
              itemId = addRes.addProjectV2ItemById.item.id;
            }

            // 4) 필드 레퍼런스
            const findField = (name) => fields.find(f => f && f.name === name);
            const priorityField  = findField(process.env.PRIORITY_FIELD_NAME);
            const componentField = findField(process.env.COMPONENT_FIELD_NAME);
            const spField        = findField(process.env.STORYPOINTS_FIELD_NAME);
            const dueField       = findField(process.env.DUEDATE_FIELD_NAME);

            // 5) 라벨 파싱
            const labels = (issueNode.labels?.nodes || []).map(l => l.name);
            const parseMap = (s) => Object.fromEntries(
              (s||"").split(',').map(e => e.trim()).filter(Boolean).map(e => {
                const [k,v] = e.split(':').map(x=>x.trim()); return [k, v];
              })
            );

            // Priority
            if (priorityField?.options?.length) {
              const prefix = (process.env.PRIORITY_PREFIX || "").toLowerCase();
              const map = parseMap(process.env.PRIORITY_MAP);
              const prioLabel = labels.find(l => l.toLowerCase().startsWith(prefix));
              if (prioLabel) {
                const key = prioLabel.slice(prefix.length).toLowerCase();
                const optionName = map[key];
                const optionId = priorityField.options.find(o => o.name === optionName)?.id;
                if (optionId) {
                  await gql(`
                    mutation($pid:ID!,$item:ID!,$fid:ID!,$opt:ID!){
                      updateProjectV2ItemFieldValue(input:{
                        projectId:$pid, itemId:$item, fieldId:$fid,
                        value:{ singleSelectOptionId:$opt }
                      }){ projectV2Item { id } }
                  `, { pid: project.id, item: itemId, fid: priorityField.id, opt: optionId });
                }
              }
            }

            // Component
            if (componentField?.options?.length) {
              const prefix = (process.env.COMPONENT_PREFIX || "").toLowerCase();
              const compLabel = labels.find(l => l.toLowerCase().startsWith(prefix));
              if (compLabel) {
                const name = compLabel.slice(prefix.length);
                const opt = componentField.options.find(o => o.name.toLowerCase() === name.toLowerCase());
                if (opt) {
                  await gql(`
                    mutation($pid:ID!,$item:ID!,$fid:ID!,$opt:ID!){
                      updateProjectV2ItemFieldValue(input:{
                        projectId:$pid, itemId:$item, fieldId:$fid,
                        value:{ singleSelectOptionId:$opt }
                      }){ projectV2Item { id } }
                  `, { pid: project.id, item: itemId, fid: componentField.id, opt: opt.id });
                }
              }
            }

            // Story Points
            if (spField) {
              const prefix = (process.env.STORYPOINTS_PREFIX || "").toLowerCase();
              const spLabel = labels.find(l => l.toLowerCase().startsWith(prefix));
              if (spLabel) {
                const num = Number(spLabel.slice(prefix.length));
                if (!Number.isNaN(num)) {
                  await gql(`
                    mutation($pid:ID!,$item:ID!,$fid:ID!,$val:Float!){
                      updateProjectV2ItemFieldValue(input:{
                        projectId:$pid, itemId:$item, fieldId:$fid,
                        value:{ number:$val }
                      }){ projectV2Item { id } }
                  `, { pid: project.id, item: itemId, fid: spField.id, val: num });
                }
              }
            }

            // Due Date ← milestone.dueOn
            if (dueField && issueNode.milestone?.dueOn) {
              await gql(`
                mutation($pid:ID!,$item:ID!,$fid:ID!,$date:Date!){
                  updateProjectV2ItemFieldValue(input:{
                    projectId:$pid, itemId:$item, fieldId:$fid,
                    value:{ date:$date }
                  }){ projectV2Item { id } }
              `, { pid: project.id, item: itemId, fid: dueField.id, date: issueNode.milestone.dueOn });
            }
