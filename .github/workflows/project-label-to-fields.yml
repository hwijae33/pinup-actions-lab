name: Sync labels to Project fields

on:
  issues:
    types: [opened, edited, labeled, unlabeled, milestoned, demilestoned]

jobs:
  sync-project-fields:
    runs-on: ubuntu-latest
    env:
      ORG: your-org         # Org 프로젝트면 ORG=실제조직, USER=""
      USER: ""              # 개인 프로젝트면 ORG="" , USER=your-username
      PROJECT_NUMBER: "1"
      PRIORITY_PREFIX: "priority/"
      COMPONENT_PREFIX: "component/"
      STORYPOINTS_PREFIX: "sp/"
      PRIORITY_MAP: "critical:Critical,high:High,medium:Medium,low:Low"
      STATUS_FIELD_NAME: "Status"
      PRIORITY_FIELD_NAME: "Priority"
      COMPONENT_FIELD_NAME: "Component"
      STORYPOINTS_FIELD_NAME: "Story Points"
      DUEDATE_FIELD_NAME: "Due Date"

    steps:
      - name: Sync to Project fields
        uses: actions/github-script@v6
        with:
          # ★ 필수: PAT 시크릿을 github-token으로 주입
          github-token: ${{ secrets.PROJECTS_TOKEN }}
          script: |
            // 외부 require 금지 (MODULE_NOT_FOUND 방지)
            // const { graphql } = require('@octokit/graphql');

            // PAT로 인증된 GraphQL 클라이언트
            const gql = github.graphql;

            const isOrg = !!process.env.ORG && process.env.ORG !== "your-org";
            const ownerVar = isOrg ? { org: process.env.ORG } : { login: process.env.USER };
            const projectNumber = Number(process.env.PROJECT_NUMBER);

            const projQuery = `
              query($org:String, $login:String, $num:Int!) {
                ${isOrg ? 'organization(login:$org)' : 'user(login:$login)'} {
                  projectV2(number:$num){
                    id
                    fields(first:100){
                      nodes {
                        ... on ProjectV2FieldCommon { id name }
                        ... on ProjectV2SingleSelectField { id name options { id name } }
                      }
                    }
                  }
                }
              }
            `;
            const projData = await gql(projQuery, { ...(ownerVar), num: projectNumber });
            const container = (isOrg ? projData.organization : projData.user);
            if (!container?.projectV2) {
              core.setFailed('Project not found. Check ORG/USER/PROJECT_NUMBER.');
              return;
            }
            const project = container.projectV2;

            // 이슈 노드
            const issueNodeRes = await gql(`
              query($id:ID!){
                node(id:$id){
                  ... on Issue {
                    id
                    labels(first:50){ nodes { name } }
                    milestone { dueOn }
                    projectItems(first:30){ nodes { id project { id } } }
                  }
                }
              }`, { id: context.payload.issue.node_id });
            const issueNode = issueNodeRes.node;

            // 프로젝트 아이템 없으면 추가
            let itemId = issueNode.projectItems.nodes.find(n => n.project.id === project.id)?.id;
            if (!itemId) {
              const addRes = await gql(`
                mutation($pid:ID!,$content:ID!){
                  addProjectV2ItemById(input:{projectId:$pid, contentId:$content}) {
                    item { id }
                  }
                }`, { pid: project.id, content: issueNode.id });
              itemId = addRes.addProjectV2ItemById.item.id;
            }

            // 필드 핸들러들...
            const fields = project.fields.nodes;
            const findField = (name) => fields.find(f => f && f.name === name);
            const priorityField = findField(process.env.PRIORITY_FIELD_NAME);
            const componentField = findField(process.env.COMPONENT_FIELD_NAME);
            const spField = findField(process.env.STORYPOINTS_FIELD_NAME);
            const dueField = findField(process.env.DUEDATE_FIELD_NAME);

            const labels = (issueNode.labels?.nodes || []).map(l => l.name);
            const parseMap = (s) => Object.fromEntries(
              s.split(',').map(e => e.trim()).filter(Boolean).map(e => {
                const [k,v] = e.split(':').map(x=>x.trim()); return [k, v];
              })
            );

            // Priority
            if (priorityField?.options?.length) {
              const prefix = process.env.PRIORITY_PREFIX.toLowerCase();
              const map = parseMap(process.env.PRIORITY_MAP);
              const prioLabel = labels.find(l => l.toLowerCase().startsWith(prefix));
              if (prioLabel) {
                const key = prioLabel.slice(prefix.length).toLowerCase();
                const optionName = map[key];
                const optionId = priorityField.options.find(o => o.name === optionName)?.id;
                if (optionId) {
                  await gql(`
                    mutation($pid:ID!,$item:ID!,$fid:ID!,$opt:ID!){
                      updateProjectV2ItemFieldValue(input:{
                        projectId:$pid, itemId:$item, fieldId:$fid,
                        value:{ singleSelectOptionId:$opt }
                      }){ projectV2Item { id } }
                  }`, { pid: project.id, item: itemId, fid: priorityField.id, opt: optionId });
                }
              }
            }

            // Component
            if (componentField?.options?.length) {
              const prefix = process.env.COMPONENT_PREFIX.toLowerCase();
              const compLabel = labels.find(l => l.toLowerCase().startsWith(prefix));
              if (compLabel) {
                const name = compLabel.slice(prefix.length);
                const opt = componentField.options.find(o => o.name.toLowerCase() === name.toLowerCase());
                if (opt) {
                  await gql(`
                    mutation($pid:ID!,$item:ID!,$fid:ID!,$opt:ID!){
                      updateProjectV2ItemFieldValue(input:{
                        projectId:$pid, itemId:$item, fieldId:$fid,
                        value:{ singleSelectOptionId:$opt }
                      }){ projectV2Item { id } }
                  }`, { pid: project.id, item: itemId, fid: componentField.id, opt: opt.id });
                }
              }
            }

            // Story Points
            if (spField) {
              const prefix = process.env.STORYPOINTS_PREFIX.toLowerCase();
              const spLabel = labels.find(l => l.toLowerCase().startsWith(prefix));
              if (spLabel) {
                const num = Number(spLabel.slice(prefix.length));
                if (!Number.isNaN(num)) {
                  await gql(`
                    mutation($pid:ID!,$item:ID!,$fid:ID!,$val:Float!){
                      updateProjectV2ItemFieldValue(input:{
                        projectId:$pid, itemId:$item, fieldId:$fid,
                        value:{ number:$val }
                      }){ projectV2Item { id } }
                  }`, { pid: project.id, item: itemId, fid: spField.id, val: num });
                }
              }
            }

            // Due Date ← milestone.dueOn
            if (dueField && issueNode.milestone?.dueOn) {
              await gql(`
                mutation($pid:ID!,$item:ID!,$fid:ID!,$date:Date!){
                  updateProjectV2ItemFieldValue(input:{
                    projectId:$pid, itemId:$item, fieldId:$fid,
                    value:{ date:$date }
                  }){ projectV2Item { id } }
              }`, { pid: project.id, item: itemId, fid: dueField.id, date: issueNode.milestone.dueOn });
            }
